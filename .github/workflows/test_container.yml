name: Container Security Scan

on:
  pull_request:
    branches:
      - develop
  schedule:
    # Run daily at JST 00:00 (UTC 15:00)
    - cron: '0 15 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  container-scan:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        compose_file: [docker-compose.yml, docker-compose-dev.yml, docker-compose-azure.yml]
        include:
          - compose_file: docker-compose.yml
            summary_file: docker_compose_summary.md
          - compose_file: docker-compose-dev.yml
            summary_file: docker_compose_dev_summary.md
          - compose_file: docker-compose-azure.yml
            summary_file: docker_compose_azure_summary.md

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Trivy Setup
        uses: aquasecurity/setup-trivy@v0.2.0
        with:
          cache: true
          version: v0.64.1

      - name: Install jq
        run: |
          echo "Installing jq..."
          sudo apt-get update && sudo apt-get install -y jq
          jq --version

      - name: Copy environment file for docker-compose
        run: |
          # Copy _env file to .env for docker-compose
          cp _env .env

      - name: Scan ${{ matrix.compose_file }} images
        if: hashFiles(matrix.compose_file)
        run: |
          echo "=== Scanning ${{ matrix.compose_file }} ==="

          # Pull and build images from compose file
          echo "Pulling and building ${{ matrix.compose_file }} images..."
          docker compose -f ${{ matrix.compose_file }} pull
          docker compose -f ${{ matrix.compose_file }} build

          # Extract images from compose file
          echo "Extracting images from ${{ matrix.compose_file }}..."
          grep -E "^[[:space:]]*image:" ${{ matrix.compose_file }} | sed 's/.*image:[[:space:]]*//' > images.txt

          # Also get built images
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" >> images.txt

          # Remove duplicates
          sort -u images.txt > images_unique.txt
          mv images_unique.txt images.txt

          echo "Images from ${{ matrix.compose_file }}:"
          cat images.txt

          # Initialize summary file
          echo "# ${{ matrix.compose_file }} Scan Results" > ${{ matrix.summary_file }}
          echo "" >> ${{ matrix.summary_file }}

          # Scan each image for CRITICAL and HIGH vulnerabilities
          total_images=0
          critical_vulns=0
          high_vulns=0
          failed_scans=0
          has_vulnerabilities=false

          while IFS= read -r image; do
            if [ -n "$image" ]; then
              total_images=$((total_images + 1))
              echo "Scanning image: $image"

              scan_file="scan_${image//[\/:]/_}.json"
              trivy image --quiet --scanners vuln --severity CRITICAL,HIGH --format json "$image" > "$scan_file" 2>&1

              if [ -f "$scan_file" ]; then
                # Check if JSON is valid and contains actual scan results
                if jq empty "$scan_file" 2>/dev/null && jq -e '.Results' "$scan_file" >/dev/null 2>&1; then
                  # Count vulnerabilities by severity - more robust parsing
                  critical_count=$(jq -r '[.Results[].Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length // 0' "$scan_file" 2>/dev/null)
                  high_count=$(jq -r '[.Results[].Vulnerabilities[]? | select(.Severity == "HIGH")] | length // 0' "$scan_file" 2>/dev/null)
                  total_vulns=$((critical_count + high_count))

                  if [ "$total_vulns" -gt 0 ]; then
                    echo "âŒ $image - Found $critical_count CRITICAL and $high_count HIGH vulnerabilities!"
                    critical_vulns=$((critical_vulns + critical_count))
                    high_vulns=$((high_vulns + high_count))
                    has_vulnerabilities=true
                    echo "## âŒ $image" >> ${{ matrix.summary_file }}
                    echo "**CRITICAL vulnerabilities found: $critical_count**" >> ${{ matrix.summary_file }}
                    echo "**HIGH vulnerabilities found: $high_count**" >> ${{ matrix.summary_file }}
                    echo "" >> ${{ matrix.summary_file }}
                    echo "### Vulnerability Details:" >> ${{ matrix.summary_file }}
                    echo '```' >> ${{ matrix.summary_file }}
                    trivy image --quiet --scanners vuln --severity CRITICAL,HIGH --format table "$image" >> ${{ matrix.summary_file }} 2>&1 || echo "Failed to get detailed results" >> ${{ matrix.summary_file }}
                    echo '```' >> ${{ matrix.summary_file }}
                    echo "" >> ${{ matrix.summary_file }}
                  else
                    echo "âœ… $image - No CRITICAL or HIGH vulnerabilities found"
                    echo "## âœ… $image" >> ${{ matrix.summary_file }}
                    echo "**No CRITICAL or HIGH vulnerabilities found**" >> ${{ matrix.summary_file }}
                    echo "" >> ${{ matrix.summary_file }}
                  fi
                else
                  echo "âš ï¸ Trivy scan failed or invalid results for $image"
                  echo "Scan file content (first 500 chars):"
                  head -c 500 "$scan_file" 2>/dev/null || echo "Cannot read scan file"
                  echo ""
                  failed_scans=$((failed_scans + 1))
                  echo "## âš ï¸ $image" >> ${{ matrix.summary_file }}
                  echo "**Trivy scan failed or invalid results**" >> ${{ matrix.summary_file }}
                  echo "" >> ${{ matrix.summary_file }}
                fi
              else
                echo "âš ï¸ $image - Scan failed or no results"
                failed_scans=$((failed_scans + 1))
                echo "## âš ï¸ $image" >> ${{ matrix.summary_file }}
                echo "**Scan failed or no results**" >> ${{ matrix.summary_file }}
                echo "" >> ${{ matrix.summary_file }}
              fi

              # Clean up current image after scanning
              echo "Cleaning up image: $image"
              docker rmi "$image" 2>/dev/null || echo "Image $image not found or already removed"
              rm -f "$scan_file"
            fi
          done < images.txt

          # Fail workflow immediately if vulnerabilities found
          if [ "$has_vulnerabilities" = true ]; then
            echo "ðŸš¨ CRITICAL/HIGH vulnerabilities detected! Failing workflow..."
            exit 1
          fi

          echo "âœ… All images in ${{ matrix.compose_file }} passed security scan!"

          # Final cleanup
          echo "Final cleanup for ${{ matrix.compose_file }}..."
          docker compose -f ${{ matrix.compose_file }} down
          docker image prune -f

      - name: Report scan results for ${{ matrix.compose_file }}
        if: always()
        run: |
          echo "=== Scan Report for ${{ matrix.compose_file }} ==="
          
          if [ -f "${{ matrix.summary_file }}" ]; then
            echo "ðŸ“Š Scan Summary:"
            echo "=================="
            cat "${{ matrix.summary_file }}"
          else
            echo "âš ï¸ No scan summary file found for ${{ matrix.compose_file }}"
          fi
