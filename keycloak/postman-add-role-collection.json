{
	"info": {
		"_postman_id": "af47aa94-d001-45e8-bd01-f3f86c75395d",
		"name": "Keycloak Add Roles",
		"description": "Role assignment and service account setup for existing realm",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "32335069"
	},
	"item": [
		{
			"name": "Check if admin-role exists",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"if (pm.response.code === 200) {",
							"    const roles = pm.response.json();",
							"    const adminRole = roles.find(role => role.name === 'admin-role');",
							"    if (adminRole) {",
							"        pm.collectionVariables.set('ADMIN_ROLE_EXISTS', 'true');",
							"        console.log('admin-role already exists, skipping creation');",
							"    } else {",
							"        pm.collectionVariables.set('ADMIN_ROLE_EXISTS', 'false');",
							"        console.log('admin-role does not exist, will create it');",
							"    }",
							"} else {",
							"    pm.collectionVariables.set('ADMIN_ROLE_EXISTS', 'false');",
							"    console.log('Error checking roles, will attempt to create admin-role');",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/roles",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"roles"
					]
				}
			},
			"response": []
		},
		{
			"name": "Add admin-role",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Check if role already exists",
							"if (pm.collectionVariables.get('ADMIN_ROLE_EXISTS') === 'true') {",
							"    console.log('admin-role already exists, skipping creation');",
							"    pm.execution.skipRequest();",
							"}"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Accept both 201 (created) and 409 (already exists) as success",
							"pm.test(\"HTTP Status Code Check 201 Created or 409 Conflict\", function () {\r",
							"    pm.expect(pm.response.code).to.be.oneOf([201, 409]);\r",
							"});",
							"",
							"if (pm.response.code === 409) {",
							"    console.log('admin-role already exists (409 Conflict) - this is expected');",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"name\": \"admin-role\",\r\n    \"description\": \"Administrator role for system management\",\r\n    \"composite\": false,\r\n    \"clientRole\": false\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/roles",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"roles"
					]
				}
			},
			"response": []
		},
		{
			"name": "Check if general-user-role exists",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"if (pm.response.code === 200) {",
							"    const roles = pm.response.json();",
							"    const generalUserRole = roles.find(role => role.name === 'general-user-role');",
							"    if (generalUserRole) {",
							"        pm.collectionVariables.set('GENERAL_USER_ROLE_EXISTS', 'true');",
							"        console.log('general-user-role already exists, skipping creation');",
							"    } else {",
							"        pm.collectionVariables.set('GENERAL_USER_ROLE_EXISTS', 'false');",
							"        console.log('general-user-role does not exist, will create it');",
							"    }",
							"} else {",
							"    pm.collectionVariables.set('GENERAL_USER_ROLE_EXISTS', 'false');",
							"    console.log('Error checking roles, will attempt to create general-user-role');",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/roles",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"roles"
					]
				}
			},
			"response": []
		},
		{
			"name": "Add general-user-role",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Check if role already exists",
							"if (pm.collectionVariables.get('GENERAL_USER_ROLE_EXISTS') === 'true') {",
							"    console.log('general-user-role already exists, skipping creation');",
							"    pm.execution.skipRequest();",
							"}"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Accept both 201 (created) and 409 (already exists) as success",
							"pm.test(\"HTTP Status Code Check 201 Created or 409 Conflict\", function () {\r",
							"    pm.expect(pm.response.code).to.be.oneOf([201, 409]);\r",
							"});",
							"",
							"if (pm.response.code === 409) {",
							"    console.log('general-user-role already exists (409 Conflict) - this is expected');",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"name\": \"general-user-role\",\r\n    \"description\": \"General user role for event participants\",\r\n    \"composite\": false,\r\n    \"clientRole\": false\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/roles",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"roles"
					]
				}
			},
			"response": []
		},
		{
			"name": "Add Basic Auth Client",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Check if client already exists",
							"if (pm.collectionVariables.get('BASIC_AUTH_CLIENT_EXISTS') === 'true') {",
							"    console.log('Basic Auth Client already exists, skipping creation');",
							"    pm.execution.skipRequest();",
							"}",
							"",
							"let clientBaseURL = pm.variables.get(\"ClientBaseURL\") ?? \"\";\r",
							"if (clientBaseURL == \"\") {\r",
							"    pm.collectionVariables.set(\"CLIENT_BASE_URL\",\"\");\r",
							"    pm.collectionVariables.set(\"WEB_ORIGIN\",\"*\");\r",
							"} else {\r",
							"    pm.collectionVariables.set(\"CLIENT_BASE_URL\",clientBaseURL);\r",
							"    pm.collectionVariables.set(\"WEB_ORIGIN\",clientBaseURL);\r",
							"}\r",
							""
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.collectionVariables.unset(\"CLIENT_BASE_URL\");\r",
							"pm.collectionVariables.unset(\"WEB_ORIGIN\");\r",
							"\r",
							"// Accept both 201 (created) and 409 (already exists) as success",
							"pm.test(\"HTTP Status Code Check 201 Created or 409 Conflict\", function () {\r",
							"    pm.expect(pm.response.code).to.be.oneOf([201, 409]);\r",
							"});",
							"",
							"if (pm.response.code === 409) {",
							"    console.log('Basic Auth Client already exists (409 Conflict) - this is expected');",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"clientId\": \"basic-auth-client\",\r\n    \"enabled\": true,\r\n    \"redirectUris\": [\r\n        \"{{CLIENT_BASE_URL}}/api/auth/callback/basic-auth-keycloak-client\"\r\n    ],\r\n    \"webOrigins\": [\r\n        \"{{WEB_ORIGIN}}\"\r\n    ],\r\n    \"publicClient\": false,\r\n    \"standardFlowEnabled\": true,\r\n    \"directAccessGrantsEnabled\": true,\r\n    \"frontchannelLogout\": true,\r\n    \"protocolMappers\": [\r\n        {\r\n            \"name\": \"userType\",\r\n            \"protocol\": \"openid-connect\",\r\n            \"protocolMapper\": \"oidc-hardcoded-claim-mapper\",\r\n            \"consentRequired\": false,\r\n            \"config\": {\r\n                \"introspection.token.claim\": \"true\",\r\n                \"claim.value\": \"general\",\r\n                \"userinfo.token.claim\": \"true\",\r\n                \"id.token.claim\": \"true\",\r\n                \"access.token.claim\": \"true\",\r\n                \"claim.name\": \"userType\",\r\n                \"jsonType.label\": \"String\",\r\n                \"access.tokenResponse.claim\": \"false\"\r\n            }\r\n        }\r\n    ]\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/clients",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"clients"
					]
				}
			},
			"response": []
		},
		{
			"name": "Enable User Profile",
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n  \"userProfileEnabled\": true\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Current User Profile",
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/users/profile",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"users",
						"profile"
					]
				}
			},
			"response": []
		},
		{
			"name": "ユーザープロファイル機能の追加",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.collectionVariables.unset(\"MERGED_PROFILE\");\r",
							"pm.test(\"HTTP Status Code Check 200 OK\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});\r",
							"\r",
							"if (pm.response.code === 200) {\r",
							"    console.log('✅ User Profile updated successfully with new attributes');\r",
							"} else {\r",
							"    console.error('❌ Failed to update User Profile');\r",
							"}"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Get current user profile first",
							"pm.sendRequest({",
							"    url: pm.variables.get(\"KeycloakRootURL\") + \"/admin/realms/\" + pm.variables.get(\"RealmName\") + \"/users/profile\",",
							"    method: 'GET',",
							"    header: {",
							"        'Authorization': \"Bearer \" + pm.variables.get(\"KeycloakAdminAccessToken\"),",
							"    },",
							"}, function (error, response) {",
							"    if (!error && response.code === 200) {",
							"        const currentProfile = response.json();",
							"        ",
							"                // Set all existing fields as required",
                        "        currentProfile.attributes.forEach(attr => {",
                        "            attr.required = { \"roles\": [\"user\"] };",
                        "        });",
							"        ",
							"                // Add new attributes (all required)",
                        "        const newAttributes = [",
                        "            {",
                        "                \"name\": \"username\",",
                        "                \"displayName\": \"ユーザー名\",",
                        "                \"validations\": {",
                        "                    \"length\": {",
                        "                        \"min\": 3,",
                        "                        \"max\": 255",
                        "                    },",
                        "                    \"username-prohibited-characters\": {},",
                        "                    \"up-username-not-idn-homograph\": {}",
                        "                },",
                        "                \"annotations\": {},",
                        "                \"required\": {",
                        "                    \"roles\": [\"user\"]",
                        "                },",
                        "                \"permissions\": {",
                        "                    \"view\": [\"admin\", \"user\"],",
                        "                    \"edit\": [\"admin\"]",
                        "                }",
                        "            },",
                        "            {",
                        "                \"name\": \"email\",",
                        "                \"displayName\": \"${email}\",",
                        "                \"validations\": {",
                        "                    \"email\": {},",
                        "                    \"length\": {",
                        "                        \"max\": 255",
                        "                    }",
                        "                },",
                        "                \"annotations\": {},",
                        "                \"required\": {",
                        "                    \"roles\": [\"user\"]",
                        "                },",
                        "                \"permissions\": {",
                        "                    \"view\": [\"admin\", \"user\"],",
                        "                    \"edit\": [\"admin\", \"user\"]",
                        "                }",
                        "            },",
                        "            {",
                        "                \"name\": \"nickname\",",
							"                \"displayName\": \"ニックネーム\",",
							"                \"validations\": {",
							"                    \"pattern\": {",
							"                        \"pattern\": \"[a-zA-Z0-9-_]+\",",
							"                        \"error-message\": \"profile.error.nickname\"",
							"                    }",
							"                },",
							"                \"annotations\": {},",
							"                \"required\": {",
							"                    \"roles\": [\"user\"]",
							"                },",
							"                \"permissions\": {",
							"                    \"view\": [\"admin\", \"user\"],",
							"                    \"edit\": [\"admin\", \"user\"]",
							"                }",
							"            },",
							"        ];",
							"        ",
							"        // Remove firstName and lastName",
							"        currentProfile.attributes = currentProfile.attributes.filter(attr => ",
							"            attr.name !== 'firstName' && attr.name !== 'lastName'",
							"        );",
							"        ",
							"        // Merge with existing attributes (replace if exists, add if new)",
							"        newAttributes.forEach(newAttr => {",
							"            const existingIndex = currentProfile.attributes.findIndex(attr => attr.name === newAttr.name);",
							"            if (existingIndex !== -1) {",
							"                // Replace existing attribute",
							"                currentProfile.attributes[existingIndex] = newAttr;",
							"            } else {",
							"                // Add new attribute",
							"                currentProfile.attributes.push(newAttr);",
							"            }",
							"        });",
							"        ",
							"        pm.collectionVariables.set(\"MERGED_PROFILE\", JSON.stringify(currentProfile));",
							"    } else {",
							"        console.error('Error getting current profile:', error);",
							"    }",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{{MERGED_PROFILE}}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/users/profile",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"users",
						"profile"
					]
				}
			},
			"response": []
		},
		{
			"name": "Check if Service Account Client exists",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"if (pm.response.code === 200) {",
							"    const clients = pm.response.json();",
							"    const serviceAccountClient = clients.find(client => client.clientId === 'role-assignment-service');",
							"    if (serviceAccountClient) {",
							"        pm.collectionVariables.set('SERVICE_ACCOUNT_CLIENT_EXISTS', 'true');",
							"        pm.collectionVariables.set('SERVICE_CLIENT_UUID', serviceAccountClient.id);",
							"        console.log('Service Account Client already exists, skipping creation');",
							"    } else {",
							"        pm.collectionVariables.set('SERVICE_ACCOUNT_CLIENT_EXISTS', 'false');",
							"        console.log('Service Account Client does not exist, will create it');",
							"    }",
							"} else {",
							"    pm.collectionVariables.set('SERVICE_ACCOUNT_CLIENT_EXISTS', 'false');",
							"    console.log('Error checking clients, will attempt to create Service Account Client');",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/clients?clientId=role-assignment-service",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"clients"
					]
				}
			},
			"response": []
		},
		{
			"name": "Service Account Client for Role Assignment",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Check if client already exists",
							"if (pm.collectionVariables.get('SERVICE_ACCOUNT_CLIENT_EXISTS') === 'true') {",
							"    console.log('Service Account Client already exists, skipping creation');",
							"    pm.execution.skipRequest();",
							"}",
							"",
							"// Generate a random client secret if not set",
							"if (!pm.variables.has(\"SERVICE_ACCOUNT_CLIENT_SECRET\") || !pm.variables.get(\"SERVICE_ACCOUNT_CLIENT_SECRET\")) {",
							"    const randomSecret = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);",
							"    pm.collectionVariables.set(\"SERVICE_ACCOUNT_CLIENT_SECRET\", randomSecret);",
							"    console.log(\"Generated random client secret:\", randomSecret);",
							"}",
							"",
							"// Get realm-management client ID for role assignment",
							"pm.sendRequest({",
							"    url: pm.variables.get(\"KeycloakRootURL\") + \"/admin/realms/\" + pm.variables.get(\"RealmName\") + \"/clients?clientId=realm-management\",",
							"    method: 'GET',",
							"    header: {",
							"        'Authorization': \"Bearer \" + pm.variables.get(\"KeycloakAdminAccessToken\"),",
							"    },",
							"}, function (error, response) {",
							"    if (!error && response.json().length > 0) {",
							"        const realmManagementClientId = response.json()[0].id;",
							"        pm.collectionVariables.set(\"REALM_MANAGEMENT_CLIENT_ID\", realmManagementClientId);",
							"        console.log(\"Realm Management Client ID:\", realmManagementClientId);",
							"    } else {",
							"        console.error(\"Error getting realm-management client:\", error);",
							"    }",
							"});"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Accept both 201 (created) and 409 (already exists) as success",
							"pm.test(\"HTTP Status Code Check 201 Created or 409 Conflict\", function () {",
							"    pm.expect(pm.response.code).to.be.oneOf([201, 409]);",
							"});",
							"",
							"if (pm.response.code === 409) {",
							"    console.log('Service Account Client already exists (409 Conflict) - this is expected');",
							"    // Still set the client ID since it exists",
							"    pm.collectionVariables.set(\"SERVICE_ACCOUNT_CLIENT_ID\", \"role-assignment-service\");",
							"    console.log(\"Service Account Client ID set to: role-assignment-service\");",
							"} else if (pm.response.code === 201) {",
							"    // Save client ID for use in application",
							"    pm.collectionVariables.set(\"SERVICE_ACCOUNT_CLIENT_ID\", \"role-assignment-service\");",
							"    console.log(\"Service Account Client ID set to: role-assignment-service\");",
							"    console.log(\"Service Account Client Secret:\", pm.collectionVariables.get(\"SERVICE_ACCOUNT_CLIENT_SECRET\"));",
							"    ",
							"    // Get client UUID from Location header",
							"    const locationHeader = pm.response.headers.get(\"Location\");",
							"    if (locationHeader) {",
							"        const clientUuid = locationHeader.split('/').pop();",
							"        pm.collectionVariables.set(\"SERVICE_CLIENT_UUID\", clientUuid);",
							"        console.log(\"Service Account Client UUID:\", clientUuid);",
							"    }",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"clientId\": \"role-assignment-service\",\r\n    \"enabled\": true,\r\n    \"serviceAccountsEnabled\": true,\r\n    \"publicClient\": false,\r\n    \"standardFlowEnabled\": false,\r\n    \"directAccessGrantsEnabled\": true,\r\n    \"clientAuthenticatorType\": \"client-secret\",\r\n    \"secret\": \"{{SERVICE_ACCOUNT_CLIENT_SECRET}}\",\r\n    \"protocol\": \"openid-connect\",\r\n    \"attributes\": {\r\n        \"access.token.lifespan\": \"300\",\r\n        \"client.secret.creation.time\": \"{{$timestamp}}\"\r\n    }\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/clients",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"clients"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Service Account User ID",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Accept both 200 (success) and 404 (not found) as valid responses",
							"pm.test(\"HTTP Status Code Check 200 OK or 404 Not Found\", function () {",
							"    pm.expect(pm.response.code).to.be.oneOf([200, 404]);",
							"});",
							"",
							"if (pm.response.code === 404) {",
							"    console.log('Service account user not found (404) - this may be expected');",
							"    pm.test('Skipped - Service account user not found', function () {",
							"        pm.expect(true).to.be.true;",
							"    });",
							"} else if (pm.response.code === 200) {",
							"    // Save service account user ID",
							"    const userInfo = pm.response.json();",
							"    pm.collectionVariables.set(\"SERVICE_ACCOUNT_USER_ID\", userInfo.id);",
							"    console.log(\"Service Account User ID:\", userInfo.id);",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/clients/{{SERVICE_CLIENT_UUID}}/service-account-user",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"clients",
						"{{SERVICE_CLIENT_UUID}}",
						"service-account-user"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Specific Realm Management Roles",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Check if we have the realm management client ID",
							"const realmManagementClientId = pm.collectionVariables.get('REALM_MANAGEMENT_CLIENT_ID');",
							"if (!realmManagementClientId) {",
							"    console.log('REALM_MANAGEMENT_CLIENT_ID not found, skipping this request');",
							"    pm.test('Skipped - No realm management client ID', function () {",
							"        pm.expect(true).to.be.true;",
							"    });",
							"    return;",
							"}",
							"",
							"// Accept both 200 (success) and 404 (not found) as valid responses",
							"pm.test(\"HTTP Status Code Check 200 OK or 404 Not Found\", function () {",
							"    pm.expect(pm.response.code).to.be.oneOf([200, 404]);",
							"});",
							"",
							"if (pm.response.code === 404) {",
							"    console.log('Realm management client not found (404) - this may be expected');",
							"    pm.test('Skipped - Realm management client not found', function () {",
							"        pm.expect(true).to.be.true;",
							"    });",
							"} else if (pm.response.code === 200) {",
							"    // Save 3 specific roles from realm-management",
							"    const allRoles = pm.response.json();",
							"    console.log(\"Available realm-management roles:\", allRoles.map(r => r.name));",
							"    ",
							"    // Only get 3 specific roles: manage-realm, manage-users, manage-clients",
							"    const targetRoles = ['manage-realm', 'manage-users', 'manage-clients'];",
							"    const selectedRoles = allRoles.filter(role => targetRoles.includes(role.name));",
							"    ",
							"    console.log(\"Selected roles:\", selectedRoles.map(r => r.name));",
							"    pm.collectionVariables.set(\"SELECTED_REALM_ROLES\", JSON.stringify(selectedRoles));",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/clients/{{REALM_MANAGEMENT_CLIENT_ID}}/roles",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"clients",
						"{{REALM_MANAGEMENT_CLIENT_ID}}",
						"roles"
					]
				}
			},
			"response": []
		},
		{
			"name": "Assign 3 Specific Realm Management Roles to Service Account",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Check if we have the required variables",
							"const serviceAccountUserId = pm.collectionVariables.get('SERVICE_ACCOUNT_USER_ID');",
							"const realmManagementClientId = pm.collectionVariables.get('REALM_MANAGEMENT_CLIENT_ID');",
							"const selectedRoles = pm.collectionVariables.get('SELECTED_REALM_ROLES');",
							"",
							"if (!serviceAccountUserId || !realmManagementClientId || !selectedRoles) {",
							"    console.log('Missing required variables, skipping role assignment');",
							"    pm.test('Skipped - Missing required variables', function () {",
							"        pm.expect(true).to.be.true;",
							"    });",
							"    return;",
							"}",
							"",
							"// Accept both 204 (success) and 404 (not found) as valid responses",
							"pm.test(\"HTTP Status Code Check 204 No Content or 404 Not Found\", function () {",
							"    pm.expect(pm.response.code).to.be.oneOf([204, 404]);",
							"});",
							"",
							"if (pm.response.code === 404) {",
							"    console.log('Service account or realm management client not found (404) - this may be expected');",
							"    pm.test('Skipped - Service account or realm management client not found', function () {",
							"        pm.expect(true).to.be.true;",
							"    });",
							"} else if (pm.response.code === 204) {",
							"    console.log(\"✅ 3 specific realm-management roles assigned to service account successfully\");",
							"}",
							"",
							"// Cleanup variables",
							"pm.collectionVariables.unset(\"SERVICE_CLIENT_UUID\");",
							"pm.collectionVariables.unset(\"SERVICE_ACCOUNT_USER_ID\");",
							"pm.collectionVariables.unset(\"REALM_MANAGEMENT_CLIENT_ID\");",
							"pm.collectionVariables.unset(\"SELECTED_REALM_ROLES\");"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{{SELECTED_REALM_ROLES}}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/users/{{SERVICE_ACCOUNT_USER_ID}}/role-mappings/clients/{{REALM_MANAGEMENT_CLIENT_ID}}",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"users",
						"{{SERVICE_ACCOUNT_USER_ID}}",
						"role-mappings",
						"clients",
						"{{REALM_MANAGEMENT_CLIENT_ID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Service Account Access Token",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Check if client ID and secret exist",
							"const clientId = pm.collectionVariables.get(\"SERVICE_ACCOUNT_CLIENT_ID\");",
							"const clientSecret = pm.collectionVariables.get(\"SERVICE_ACCOUNT_CLIENT_SECRET\");",
							"",
							"if (!clientId || !clientSecret) {",
							"    console.error(\"Missing SERVICE_ACCOUNT_CLIENT_ID or SERVICE_ACCOUNT_CLIENT_SECRET. Please run 'Service Account Client for Role Assignment' first.\");",
							"    pm.execution.skipRequest();",
							"}"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"HTTP Status Code Check 200 OK\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"// Save access token for use",
							"if (pm.response.code === 200) {",
							"    const responseJson = pm.response.json();",
							"    pm.collectionVariables.set(\"SERVICE_ACCOUNT_ACCESS_TOKEN\", responseJson.access_token);",
							"    console.log(\"Service Account Access Token obtained successfully\");",
							"    console.log(\"Token expires in:\", responseJson.expires_in, \"seconds\");",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/x-www-form-urlencoded",
						"type": "text"
					}
				],
				"body": {
					"mode": "urlencoded",
					"urlencoded": [
						{
							"key": "grant_type",
							"value": "client_credentials",
							"type": "text"
						},
						{
							"key": "client_id",
							"value": "{{SERVICE_ACCOUNT_CLIENT_ID}}",
							"type": "text"
						},
						{
							"key": "client_secret",
							"value": "{{SERVICE_ACCOUNT_CLIENT_SECRET}}",
							"type": "text"
						}
					]
				},
				"url": {
					"raw": "{{KeycloakRootURL}}/realms/{{RealmName}}/protocol/openid-connect/token",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"realms",
						"{{RealmName}}",
						"protocol",
						"openid-connect",
						"token"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Google Identity Provider",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"HTTP Status Code Check 200 OK\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"if (pm.response.code === 200) {",
							"    const provider = pm.response.json();",
							"    pm.collectionVariables.set(\"GoogleProviderConfig\", JSON.stringify(provider));",
							"    console.log('✅ Google Identity Provider retrieved successfully');",
							"} else {",
							"    console.error('❌ Failed to get Google Identity Provider');",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/identity-provider/instances/google",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"identity-provider",
						"instances",
						"google"
					]
				}
			},
			"response": []
		},
		{
			"name": "Update Google Identity Provider for Auto Email Mapping",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Get current provider config",
							"pm.sendRequest({",
							"    url: pm.variables.get(\"KeycloakRootURL\") + \"/admin/realms/\" + pm.variables.get(\"RealmName\") + \"/identity-provider/instances/google\",",
							"    method: 'GET',",
							"    header: {",
							"        'Authorization': \"Bearer \" + pm.variables.get(\"KeycloakAdminAccessToken\"),",
							"    },",
							"}, function (error, response) {",
							"    if (!error && response.code === 200) {",
							"        const provider = response.json();",
							"        ",
							"        // Update configuration for auto email mapping",
							"        provider.trustEmail = true;",
							"        provider.updateProfileFirstLoginMode = \"on\";",
							"        provider.config.defaultScope = \"openid email profile\";",
							"        ",
							"        pm.collectionVariables.set(\"UpdatedGoogleProviderConfig\", JSON.stringify(provider));",
							"    } else {",
							"        console.error('Failed to get Google Identity Provider:', error);",
							"    }",
							"});"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.collectionVariables.unset(\"UpdatedGoogleProviderConfig\");",
							"",
							"pm.test(\"HTTP Status Code Check 204 No Content\", function () {",
							"    pm.response.to.have.status(204);",
							"});",
							"",
							"if (pm.response.code === 204) {",
							"    console.log('✅ Google Identity Provider updated successfully for auto email mapping');",
							"} else {",
							"    console.error('❌ Failed to update Google Identity Provider');",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{{UpdatedGoogleProviderConfig}}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/identity-provider/instances/google",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"identity-provider",
						"instances",
						"google"
					]
				}
			},
			"response": []
		},
		{
			"name": "Test Service Account with Admin API",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Check if access token exists",
							"const accessToken = pm.collectionVariables.get(\"SERVICE_ACCOUNT_ACCESS_TOKEN\");",
							"if (!accessToken) {",
							"    console.error(\"Missing SERVICE_ACCOUNT_ACCESS_TOKEN. Please run 'Get Service Account Access Token' first.\");",
							"    pm.execution.skipRequest();",
							"}"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"HTTP Status Code Check 200 OK\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"// Check if response contains realm info",
							"if (pm.response.code === 200) {",
							"    const responseJson = pm.response.json();",
							"    pm.test(\"Response contains realm information\", function () {",
							"        pm.expect(responseJson).to.have.property('realm');",
							"        pm.expect(responseJson.realm).to.equal(pm.variables.get(\"RealmName\"));",
							"    });",
							"    console.log(\"✅ Service Account has admin access to Keycloak API\");",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{SERVICE_ACCOUNT_ACCESS_TOKEN}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Check if Basic Auth Client exists",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"if (pm.response.code === 200) {",
							"    const clients = pm.response.json();",
							"    const basicAuthClient = clients.find(client => client.clientId === 'basic-auth-client');",
							"    if (basicAuthClient) {",
							"        pm.collectionVariables.set('BASIC_AUTH_CLIENT_EXISTS', 'true');",
							"        pm.collectionVariables.set('BASIC_AUTH_CLIENT_ID', basicAuthClient.id);",
							"        console.log('Basic Auth Client already exists, skipping creation');",
							"    } else {",
							"        pm.collectionVariables.set('BASIC_AUTH_CLIENT_EXISTS', 'false');",
							"        console.log('Basic Auth Client does not exist, will create it');",
							"    }",
							"} else {",
							"    pm.collectionVariables.set('BASIC_AUTH_CLIENT_EXISTS', 'false');",
							"    console.log('Error checking clients, will attempt to create Basic Auth Client');",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/clients?clientId=basic-auth-client",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"clients"
					]
				}
			},
			"response": []
		},
		{
			"name": "Add Basic Auth Client with Email Support",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Check if client already exists",
							"if (pm.collectionVariables.get('BASIC_AUTH_CLIENT_EXISTS') === 'true') {",
							"    console.log('Basic Auth Client already exists, skipping creation');",
							"    pm.execution.skipRequest();",
							"}",
							"",
							"let clientBaseURL = pm.variables.get(\"ClientBaseURL\") ?? \"\";",
							"if (clientBaseURL == \"\") {",
							"    pm.collectionVariables.set(\"CLIENT_BASE_URL\",\"\");",
							"    pm.collectionVariables.set(\"WEB_ORIGIN\",\"*\");",
							"} else {",
							"    pm.collectionVariables.set(\"CLIENT_BASE_URL\",clientBaseURL);",
							"    pm.collectionVariables.set(\"WEB_ORIGIN\",clientBaseURL);",
							"}"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.collectionVariables.unset(\"CLIENT_BASE_URL\");",
							"pm.collectionVariables.unset(\"WEB_ORIGIN\");",
							"",
							"// Accept both 201 (created) and 409 (already exists) as success",
							"pm.test(\"HTTP Status Code Check 201 Created or 409 Conflict\", function () {",
							"    pm.expect(pm.response.code).to.be.oneOf([201, 409]);",
							"});",
							"",
							"if (pm.response.code === 409) {",
							"    console.log('Basic Auth Client already exists (409 Conflict) - this is expected');",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"clientId\": \"basic-auth-client\",\n    \"enabled\": true,\n    \"redirectUris\": [\n        \"{{CLIENT_BASE_URL}}/api/auth/callback/basic-auth-keycloak-client\"\n    ],\n    \"webOrigins\": [\n        \"{{WEB_ORIGIN}}\"\n    ],\n    \"publicClient\": false,\n    \"standardFlowEnabled\": true,\n    \"directAccessGrantsEnabled\": true,\n    \"frontchannelLogout\": true,\n    \"protocolMappers\": [\n        {\n            \"name\": \"userType\",\n            \"protocol\": \"openid-connect\",\n            \"protocolMapper\": \"oidc-hardcoded-claim-mapper\",\n            \"consentRequired\": false,\n            \"config\": {\n                \"introspection.token.claim\": \"true\",\n                \"claim.value\": \"general\",\n                \"userinfo.token.claim\": \"true\",\n                \"id.token.claim\": \"true\",\n                \"access.token.claim\": \"true\",\n                \"claim.name\": \"userType\",\n                \"jsonType.label\": \"String\",\n                \"access.tokenResponse.claim\": \"false\"\n            }\n        },\n        {\n            \"name\": \"email\",\n            \"protocol\": \"openid-connect\",\n            \"protocolMapper\": \"oidc-usermodel-attribute-mapper\",\n            \"consentRequired\": false,\n            \"config\": {\n                \"introspection.token.claim\": \"true\",\n                \"userinfo.token.claim\": \"true\",\n                \"user.attribute\": \"email\",\n                \"id.token.claim\": \"true\",\n                \"access.token.claim\": \"true\",\n                \"claim.name\": \"email\",\n                \"jsonType.label\": \"String\"\n            }\n        }\n    ],\n    \"attributes\": {\n        \"policyUri\": \"{{CLIENT_BASE_URL}}/terms/privacy-policy\",\n        \"tosUri\": \"{{CLIENT_BASE_URL}}/terms/use\"\n    }\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}/clients",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}",
						"clients"
					]
				}
			},
			"response": []
		},
		{
			"name": "Configure Realm for Username and Email Registration",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Get current realm settings to merge with new settings",
							"pm.sendRequest({",
							"    url: pm.variables.get(\"KeycloakRootURL\") + \"/admin/realms/\" + pm.variables.get(\"RealmName\"),",
							"    method: 'GET',",
							"    header: {",
							"        'Authorization': \"Bearer \" + pm.variables.get(\"KeycloakAdminAccessToken\"),",
							"    },",
							"}, function (error, response) {",
							"    if (!error) {",
							"        const realm = response.json();",
							"        // Update only the email-related settings",
							"        realm.registrationEmailAsUsername = false;",
							"        realm.loginWithEmailAllowed = true;",
							"        realm.verifyEmail = false;",
							"        realm.duplicateEmailsAllowed = false;",
							"        ",
							"        pm.collectionVariables.set(\"REALM_UPDATE_BODY\", JSON.stringify(realm));",
							"    } else {",
							"        console.error('Error getting realm settings:', error);",
							"    }",
							"});"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.collectionVariables.unset(\"REALM_UPDATE_BODY\");",
							"",
							"pm.test(\"HTTP Status Code Check 204 No Content\", function () {",
							"    pm.response.to.have.status(204);",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{KeycloakAdminAccessToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{{REALM_UPDATE_BODY}}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{KeycloakRootURL}}/admin/realms/{{RealmName}}",
					"host": [
						"{{KeycloakRootURL}}"
					],
					"path": [
						"admin",
						"realms",
						"{{RealmName}}"
					]
				}
			},
			"response": []
		}
	],
	"auth": {
		"type": "bearer",
		"bearer": [
			{
				"key": "token",
				"value": "{{KeycloakAdminAccessToken}}",
				"type": "string"
			}
		]
	},
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"pm.sendRequest({",
					"    url:  pm.variables.get(\"KeycloakTokenEndpoint\"), ",
					"    method: 'POST',",
					"    header: {",
					"    'Content-Type': 'application/x-www-form-urlencoded',",
					"    },",
					"    body: {",
					"    mode: 'urlencoded',",
					"    urlencoded: [",
					"        {",
					"            key: \"grant_type\",",
					"            value: \"password\"",
					"        },",
					"        {",
					"            key: \"client_id\",",
					"            value: \"admin-cli\"",
					"        },",
					"        {",
					"            key: \"username\",",
					"            value: pm.variables.get(\"KeycloakAdminUser\")",
					"        },",
					"        {",
					"            key: \"password\",",
					"            value: pm.variables.get(\"KeycloakAdminPassword\")",
					"        }",
					"    ]",
					"}",
					"}, function (error, res) {",
					"    if (!error) {",
					"        pm.variables.set(\"KeycloakAdminAccessToken\", res.json().access_token);",
					"    } else {",
					"        console.error(error);",
					"    }",
					"});"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	]
}
